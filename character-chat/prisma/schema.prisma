generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =============================================
// VOICE-FIRST ARCHITECTURE (Rule Zero)
// Voices are first-class objects. Characters are derived.
// =============================================

// =============================================
// VOICE SEED (Elite Voice Pool - 29 Base Voices)
// These are the immutable source assets. Characters select from this pool.
// =============================================
model VoiceSeed {
  id           String   @id @default(cuid())
  name         String   @unique  // "Movetrailer", "WiseSage", etc.
  filePath     String              // "/voices/seeds/Movetrailer.mp3"
  gender       String              // "male", "female", "neutral"
  age          String              // "young", "adult", "middle_aged", "elderly", "ageless"
  tone         String              // "deep", "bright", "raspy", "soft", "warm", etc.
  energyDescription String?             // "calm", "epic", "chaotic", "intimate", "zen", etc.
  accent       String              // "american", "british", "french", "australian", etc.
  category     String              // "Authority", "Mentor", "Energetic", "Texture", "Global"
  tags         String              // JSON array: ["narrator", "villain", "comedy"]
  suitableFor  String              // JSON array: ["villains", "mentors", "heroes"]
  description  String?             // Human-readable description
  referenceText String?            // Transcript of the reference audio (Prevents double-talk)
  
  // === ACOUSTIC SIGNATURE (Tree-0 v2 Immutable Profile) ===
  sourceProvider String?           // "elevenlabs_clone", "f5_seed"
  sourceVoiceId  String?           // External ID if applicable
  
  // Acoustic Parameters (Locked)
  pitch          Float             @default(0.0) // Relative pitch
  speed          Float             @default(1.0)
  timbre         String?           // "warm_dry", "metallic", etc.
  cadence        String?           // "measured", "rapid", "halted"
  energy         Float             @default(0.5) // 0.0-1.0
  aggression     Float             @default(0.0)
  
  // Constraints
  allowedPitchRange String?        // JSON: [-2.0, 2.0]
  allowedSpeedRange String?        // JSON: [0.8, 1.2]
  prosodyVariance   Float          @default(0.2)
  
  ttsEngine      String?            // "f5", "fish" (Legacy compatibility)
  pitchShift     Float              @default(0.0) // (Legacy compatibility)
  speechRate     Float              @default(1.0) // (Legacy compatibility)
  stability      Float              @default(0.5) // (Legacy compatibility)
  
  // Relations
  characters   PersonaTemplate[]   @relation("VoiceSeedCharacters")
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@map("voice_seeds")
  @@index([gender])
  @@index([category])
  @@index([accent])
}

model VoiceIdentity {
  id              String   @id @default(cuid())
  voiceId         String   @unique  // Immutable: e.g., "voice_oxford_female_01"
  
  // === Layer 1: VOICE IDENTITY (Human-Readable, Immutable) ===
  gender          String   // male | female
  ageBand         String   // young | adult | middle-aged | elderly
  originRegion    String   // e.g., west_africa, england_oxford
  accent          String   // african_english | british-rp | etc.
  ethnicityAnchor String?  // black | white | asian | etc.
  authorityLevel  String?  // soft | neutral | commanding | dominant
  
  // === Layer 2: NUMERIC VOICE LOCK (TTS-Enforced) ===
  // Pitch (Hz or relative scale)
  pitchMin        Int      @default(100)
  pitchMax        Int      @default(200)
  
  // Speed (Words per minute or scalar * 100)
  speakingRateMin Int      @default(90)
  speakingRateMax Int      @default(110)
  
  // Dynamics (0-100)
  energyBaseline  Int      @default(50)
  aggressionBaseline Int   @default(0)
  
  // Timbre & Texture (0-100)
  articulationPrecision Int @default(50)
  rhythmVariability     Int @default(50)
  warmth               Int  @default(50)
  roughness            Int  @default(10)
  
  // Internal Locks
  accentId             Int  @default(0)
  genderLock           Int  @default(0) // 0=female, 1=male
  ageLock              Int  @default(1) // 0=young, 1=adult, 2=middle, 3=elderly
  
  // === Layer 3: NEGATIVE CONSTRAINTS (Crucial) ===
  voiceProhibitions    String  @default("{}") // JSON string: { forbidden_accents: [], forbidden_genders: [] }
  
  // Legacy / Compatibility Fields (To be phased out or mapped)
  language        String   @default("en") 
  socialRegister  String?
  timbre          String?
  energyLevel     String?
  aggressionLevel String?
  speakingRate    Float    @default(1.0)
  pitchBaselineHz Int      @default(150)
  pitchVariance   String?
  cadenceStyle    String?
  
  // v2 Fields
  expressivenessLevel  String   @default("controlled")
  emotionalLeakage     String   @default("none")
  articulationStyle    String   @default("precise")
  confidenceStability  String   @default("steady")
  breathiness          String   @default("none")
  quirkTag             String?

  villainCapable  Boolean  @default(false)
  
  // Reference Audio
  referenceAudioPath String
  referenceText      String?
  
  // Metadata
  displayName     String?
  description     String?
  voiceDescription String? // Natural language prompt
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relation to characters
  characters      PersonaTemplate[]
  
  @@map("voice_identities")
  @@index([gender])
  @@index([accent])
}

model PersonaTemplate {
  id                   String                    @id @default(cuid())
  seedId               String?                   @unique
  name                 String
  handle               String?
  tagline              String?
  description          String?
  greeting             String?
  category             String
  avatarUrl            String
  voiceName            String
  styleHint            String?
  voiceSpeed           Float?
  voicePitch           Float?
  systemPrompt         String
  age                  Int?
  gender               String?
  heritage             String?
  accentProfile        String?
  ttsVoiceSpec         String?
  faceDescription      String?
  prompts              String?
  totalChats           String?
  referenceAudioUrl    String?
  referenceAudioBase64 String?
  openVoiceVoiceId     String?
  archetype            String
  tonePack             String?
  scenarioSkin         String?
  sourceCharacterName  String?
  sourceCharacterUrl   String?
  sourceType           String?
  sourceDescription    String?
  characterKeywords    String?
  mappingConfidence    Float?
  viewCount            Int                       @default(0)
  chatCount            Int                       @default(0)
  followerCount        Int                       @default(0)
  interactionCount     Int                       @default(0)
  saveCount            Int                       @default(0)
  commentCount         Int                       @default(0)
  retentionScore       Float                     @default(0.0)
  featured             Boolean                   @default(false)
  trending             Boolean                   @default(false)
  voiceReady           Boolean                   @default(false)
  lastRankedAt         DateTime?
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @updatedAt
  creationError        String?
  creationMessage      String?
  creationProgress     Int?                      @default(0)
  creationStatus       String?
  behaviorAgreeable    Float?                    @default(50)
  behaviorEmpathy      Float?                    @default(50)
  knowledgeBaseUrl     String?
  styleFormality       Float?                    @default(50)
  styleVerbosity       Float?                    @default(50)
  trainingConstraints  String?
  trainingStatus       String?                   @default("untrained")
  behaviorChaos        Float?                    @default(50)
  behaviorPessimism    Float?                    @default(50)
  personalityTags      String?
  
  // VOICE-FIRST: Link to canonical voice identity
  voiceIdentityId      String?
  voiceIdentity        VoiceIdentity?            @relation(fields: [voiceIdentityId], references: [id])
  
  // VOICE POOL: Link to Elite Voice Seed (29 base voices)
  voiceSeedId          String?
  voiceSeed            VoiceSeed?                @relation("VoiceSeedCharacters", fields: [voiceSeedId], references: [id])
  
  comments             CharacterComment[]
  evolutions           CharacterEvolution[]
  memories             CharacterMemory[]
  saves                CharacterSave[]
  conversations        Conversation[]
  patterns             ConversationPattern[]
  views                PersonaView[]
  engagements          UserCharacterEngagement[]
  followers            UserFollow[]
  voiceParameters      VoiceParameters[]
  voicePerformances    VoicePerformance[]

  @@index([category])
  @@index([seedId])
  @@index([archetype])
  @@index([retentionScore])
  @@index([featured])
  @@index([trending])
  @@index([voiceIdentityId])
  @@index([voiceSeedId])
}

model Conversation {
  id        String          @id @default(cuid())
  personaId String
  userId    String?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  user      User?           @relation(fields: [userId], references: [id], onDelete: Cascade)
  persona   PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)
  messages  Message[]

  @@index([personaId])
  @@index([userId])
}

model Message {
  id             String           @id @default(cuid())
  conversationId String
  role           String
  text           String
  audioUrl       String?
  createdAt      DateTime         @default(now())
  conversation   Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  feedback       MessageFeedback?
  pinned         PinnedMessage?
  voiceFeedback  VoiceFeedback?

  @@index([conversationId])
}

model MessageFeedback {
  id           String   @id @default(cuid())
  messageId    String   @unique
  userId       String?
  rating       Int?
  thumbsUp     Boolean?
  thumbsDown   Boolean?
  feedbackText String?
  createdAt    DateTime @default(now())
  user         User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  message      Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model CharacterMemory {
  id               String          @id @default(cuid())
  personaId        String
  userId           String          @default("")
  facts            String          @default("{}")
  preferences      String          @default("{}")
  patterns         String          @default("{}")
  emotionalState   String?
  interactionCount Int             @default(0)
  confidenceScore  Float           @default(0.5)
  lastInteraction  DateTime        @default(now())
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  persona          PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@unique([personaId, userId])
  @@index([personaId])
  @@index([userId])
}

model ConversationPattern {
  id           String          @id @default(cuid())
  personaId    String
  patternType  String
  patternKey   String
  patternValue String
  frequency    Int             @default(1)
  confidence   Float           @default(0.5)
  lastSeen     DateTime        @default(now())
  createdAt    DateTime        @default(now())
  persona      PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@unique([personaId, patternType, patternKey])
  @@index([personaId])
  @@index([confidence])
}

model CharacterEvolution {
  id                 String          @id @default(cuid())
  personaId          String
  version            Int
  improvements       String
  performanceMetrics String
  totalInteractions  Int             @default(0)
  averageRating      Float           @default(0.0)
  responseQuality    Float           @default(0.5)
  lastEvolved        DateTime        @default(now())
  createdAt          DateTime        @default(now())
  persona            PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@unique([personaId, version])
  @@index([personaId])
  @@index([version])
}

model UserQuota {
  id               String   @id @default(cuid())
  userId           String   @unique
  textRepliesToday Int      @default(0)
  ttsSecondsToday  Int      @default(0)
  callMinutesToday Int      @default(0)
  lastResetDate    DateTime @default(now())

  @@index([userId])
}

model Subscription {
  id                   String    @id @default(cuid())
  userId               String    @unique
  planId               String
  status               String
  currentPeriodEnd     DateTime?
  stripeCustomerId     String?
  stripeSubscriptionId String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@index([userId])
  @@index([status])
}

model User {
  id                 String                    @id @default(cuid())
  email              String?                   @unique
  username           String?                   @unique
  displayName        String?
  bio                String?
  avatarUrl          String?
  dateOfBirth        DateTime?
  ageVerified        Boolean                   @default(false)
  ageVerifiedAt      DateTime?
  subscriptionTier   String                    @default("free")
  stripeCustomerId   String?                   @unique
  subscriptionId     String?                   @unique
  subscriptionStatus String?
  creditsBalance     Int                       @default(100)
  referralCode       String?                   @unique
  referredBy         String?
  referralCount      Int                       @default(0)
  referralClicks     Int                       @default(0)
  affiliateEarnings  Float                     @default(0)
  unpaidEarnings     Float                     @default(0)
  stripeConnectId    String?
  createdAt          DateTime                  @default(now())
  updatedAt          DateTime                  @updatedAt
  characterComments  CharacterComment[]
  savedCharacters    CharacterSave[]
  conversations      Conversation[]
  creditPurchases    CreditPurchase[]
  creditTransactions CreditTransaction[]
  feedback           MessageFeedback[]
  payouts            Payout[]
  views              PersonaView[]
  pinnedMessages     PinnedMessage[]
  referralPurchases  ReferralPurchase[]
  engagements        UserCharacterEngagement[]
  following          UserFollow[]
  loginStreak        UserLoginStreak?
  rewardProgress     UserRewardProgress[]
  voiceFeedback      VoiceFeedback[]
  voiceContributions VoiceContribution[]
  consentLogs        ConsentLog[]

  @@index([username])
  @@index([email])
  @@index([subscriptionTier])
  @@index([stripeCustomerId])
}

model UserFollow {
  id        String          @id @default(cuid())
  userId    String
  personaId String
  createdAt DateTime        @default(now())
  persona   PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, personaId])
  @@index([personaId])
  @@index([userId])
}

model PersonaView {
  id        String          @id @default(cuid())
  personaId String
  userId    String?
  viewedAt  DateTime        @default(now())
  user      User?           @relation(fields: [userId], references: [id], onDelete: Cascade)
  persona   PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@index([personaId])
  @@index([userId])
  @@index([viewedAt])
}

model PinnedMessage {
  id        String   @id @default(cuid())
  messageId String   @unique
  userId    String
  pinnedAt  DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VoicePerformance {
  id              String          @id @default(cuid())
  personaId       String
  voiceName       String
  userId          String?
  rating          Float           @default(3.0)
  engagementScore Float           @default(0.5)
  usageCount      Int             @default(0)
  lastUsed        DateTime        @default(now())
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  persona         PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@unique([personaId, voiceName, userId])
  @@index([personaId])
  @@index([rating])
  @@index([engagementScore])
}

model VoiceParameters {
  id               String          @id @default(cuid())
  personaId        String
  voiceName        String
  speed            Float           @default(1.0)
  pitch            Float           @default(1.0)
  styleHint        String?
  confidence       Float           @default(0.5)
  performanceScore Float           @default(0.0)
  usageCount       Int             @default(0)
  lastOptimized    DateTime        @default(now())
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  persona          PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@unique([personaId, voiceName])
  @@index([personaId])
  @@index([performanceScore])
}

model VoiceFeedback {
  id                String   @id @default(cuid())
  messageId         String   @unique
  personaId         String
  voiceName         String
  userId            String?
  voiceRating       Int?
  speedRating       Int?
  pitchRating       Int?
  naturalnessRating Int?
  feedbackText      String?
  createdAt         DateTime @default(now())
  user              User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  message           Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([personaId])
  @@index([voiceName])
  @@index([userId])
}

model CharacterSave {
  id        String          @id @default(cuid())
  personaId String
  userId    String
  createdAt DateTime        @default(now())
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  persona   PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@unique([userId, personaId])
  @@index([personaId])
  @@index([userId])
}

model CharacterComment {
  id        String          @id @default(cuid())
  personaId String
  userId    String
  text      String
  isPublic  Boolean         @default(true)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  persona   PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@index([personaId])
  @@index([userId])
  @@index([createdAt])
}

model TTSCache {
  id          String   @id @default(cuid())
  textHash    String   @unique
  text        String
  voiceId     String
  engine      String
  audioBase64 String
  format      String
  contentType String
  sampleRate  Int
  hitCount    Int      @default(0)
  lastUsed    DateTime @default(now())
  createdAt   DateTime @default(now())

  @@index([engine])
  @@index([hitCount])
  @@index([lastUsed])
}

model CreditPack {
  id            String           @id @default(cuid())
  name          String
  credits       Int
  priceUsd      Float
  stripePriceId String?          @unique
  isActive      Boolean          @default(true)
  displayOrder  Int              @default(0)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  purchases     CreditPurchase[]

  @@index([isActive])
  @@index([displayOrder])
}

model CreditPurchase {
  id              String      @id @default(cuid())
  userId          String
  creditPackId    String?
  creditsAdded    Int
  amountPaid      Float
  stripeSessionId String?     @unique
  status          String      @default("pending")
  createdAt       DateTime    @default(now())
  creditPack      CreditPack? @relation(fields: [creditPackId], references: [id])
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model CreditTransaction {
  id           String   @id @default(cuid())
  userId       String
  amount       Int
  actionType   String
  description  String?
  balanceAfter Int
  metadata     String?  @default("{}")
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([actionType])
  @@index([createdAt])
}

model ReferralPurchase {
  id             String    @id @default(cuid())
  referrerId     String
  purchaseAmount Float
  commissionRate Float     @default(0.30)
  commission     Float
  status         String    @default("pending")
  holdUntil      DateTime?
  createdAt      DateTime  @default(now())
  paidAt         DateTime?
  referrer       User      @relation(fields: [referrerId], references: [id], onDelete: Cascade)

  @@index([referrerId])
  @@index([status])
  @@index([createdAt])
}

model Payout {
  id        String    @id @default(cuid())
  userId    String
  amount    Float
  status    String    @default("processing")
  period    String
  createdAt DateTime  @default(now())
  paidAt    DateTime?
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model UserRewardProgress {
  id        String    @id @default(cuid())
  userId    String
  rewardId  String
  progress  Int       @default(0)
  claimed   Boolean   @default(false)
  claimedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, rewardId])
  @@index([userId])
}

model UserCharacterEngagement {
  id            String          @id @default(cuid())
  userId        String
  personaId     String
  messagesSent  Int             @default(0)
  lastChatAt    DateTime?
  totalChatTime Int             @default(0)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  persona       PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, personaId])
  @@index([userId])
  @@index([personaId])
}

model UserLoginStreak {
  id            String   @id @default(cuid())
  userId        String   @unique
  currentStreak Int      @default(0)
  longestStreak Int      @default(0)
  lastLoginDate DateTime @default(now())
  createdAt     DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model NewsletterSubscriber {
  id           String   @id @default(cuid())
  email        String   @unique
  subscribedAt DateTime @default(now())
  source       String   @default("landing_page")
  isActive     Boolean  @default(true)

  @@index([email])
}

// =============================================
// BLOG ENGAGEMENT
// =============================================

model BlogLike {
  id        String   @id @default(cuid())
  slug      String   // Blog post slug
  userId    String?  // Optional user ID
  sessionId String?  // For anonymous likes
  createdAt DateTime @default(now())

  @@unique([slug, userId])
  @@unique([slug, sessionId])
  blogPostId String?
  blogPost   BlogPost? @relation(fields: [blogPostId], references: [id], onDelete: Cascade)

  @@unique([slug, userId], map: "BlogLike_slug_userId_unique")
  @@unique([slug, sessionId], map: "BlogLike_slug_sessionId_unique")
  @@index([slug])
  @@index([blogPostId])
}

model BlogComment {
  id        String   @id @default(cuid())
  slug      String   // Blog post slug
  userId    String?
  name      String   // Display name (for anonymous or logged in)
  email     String?  // Optional email
  content   String
  approved  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  blogPostId String?
  blogPost   BlogPost? @relation(fields: [blogPostId], references: [id], onDelete: Cascade)

  @@index([slug])
  @@index([createdAt])
  @@index([blogPostId])
}

// =============================================
// PHASE 2: VOICE JOBS & WORKERS (Runtime)
// =============================================

model VoiceJob {
  id           String   @id @default(cuid())
  characterId  String
  seedVoiceId  String
  engine       String   // "f5", "fish"
  status       String   // "queued", "running", "complete", "failed"
  latencyMs    Int?
  error        String?
  audioUrl     String?  // Result
  createdAt    DateTime @default(now())

  @@map("voice_jobs")
  @@index([characterId])
  @@index([status])
}


// =============================================
// BLOG SYSTEM (Database Backed for Scale)
// =============================================

model BlogPost {
  id              String   @id @default(cuid())
  slug            String   @unique
  title           String
  content         String   @db.Text // Markdown or HTML
  excerpt         String?
  metaDescription String?
  image           String?
  author          String   @default("Agentwood Editorial")
  tags            String[] @default([])
  publishedAt     DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  viewCount       Int      @default(0)
  
  // Relations
  likes           BlogLike[]
  comments        BlogComment[]

  @@index([publishedAt])
  @@index([slug])
}

// Update relations in existing models if needed
// BlogLike and BlogComment already exist but need relation updates if we want strict integrity
// For now, keeping them loose or we can update them to point to BlogPost. 
// The existing schema has BlogLike and BlogComment models, let's update them to link to BlogPost.


// =============================================
// VOICE CONTRIBUTION ECONOMY
// User-contributed voices with usage tracking and rewards
// =============================================

model VoiceContribution {
  id                    String   @id @default(cuid())
  contributorId         String
  contributor           User     @relation(fields: [contributorId], references: [id], onDelete: Cascade)

  // Audio Asset
  audioFilePath         String   // S3/Supabase path
  audioDurationSeconds  Float
  audioFormat           String   // "wav", "mp3"
  
  // Voice Identity & Security
  pocketTtsSeed         String?  @db.Text // Base64 encoded seed or storage path
  fingerprintHash       String?  // Audio fingerprint for fraud detection
  
  // Quality & Status
  version               Int      @default(1)
  parentVoiceId         String?  // For versioning
  qualityScore          Int      @default(0)  // 0-100
  noiseScore            Int      @default(0)  // 0-100 (lower is better)
  status                String   @default("processing") // processing, pending_review, approved, rejected
  rejectionReason       String?
  
  // Consent & Licensing (Defensible)
  consentLogId          String?  @unique
  consentLog            ConsentLog? @relation(fields: [consentLogId], references: [id])
  allowEnterpriseResale Boolean  @default(false)
  licensingType         String   @default("platform_standard") // platform_standard, cc_by_nc, exclusive
  isPaused              Boolean  @default(false)
  
  // Tree-0 Acoustic Profile (Generated)
  acousticEmbedding     String?  @db.Text // JSON: 512-dim vector
  
  // Tree-0 Tagging Taxonomy (Normalized)
  // Structure: { acoustic: { pitch: "medium", tempo: "fast" }, emotion: { baseline: "neutral" }, useCase: { companion: true } }
  tree0Tags             String?  @db.Text 
  
  // Display
  displayName           String?
  description           String?
  gender                String?
  age                   String?
  accent                String?
  
  // Usage Tracking (Aggregated - updated by cron)
  totalMinutesUsed      Float    @default(0)
  uniqueUsersServed     Int      @default(0)
  activeCharacterCount  Int      @default(0)
  
  // Rewards (Accrued, not yet settled)
  accruedAwsTokens      Float    @default(0)
  accruedCashUsd        Float    @default(0)
  lifetimeEarningsUsd   Float    @default(0)
  
  // Relations
  usageEvents           VoiceUsageEvent[]
  rewardLedger          VoiceRewardLedger[]
  settlements           VoiceSettlement[]
  characterLinks        VoiceCharacterLink[]
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  approvedAt            DateTime?
  
  @@index([contributorId])
  @@index([status])
  @@index([qualityScore])
  @@index([totalMinutesUsed])
  @@map("voice_contributions")
}

model ConsentLog {
  id               String   @id @default(cuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Terms Agreed To
  termsVersion     String   // e.g., "v1.0-2026-01"
  termsTextHash    String   // SHA256 of the text displayed
  
  // Flags
  allowSynthesized Boolean  @default(true)
  allowEnterprise  Boolean  @default(false)
  allowTraining    Boolean  @default(false)
  
  // Context
  ipAddress        String?
  userAgent        String?
  timestamp        DateTime @default(now())
  
  // Relation
  voiceContribution VoiceContribution?
  
  @@index([userId])
  @@index([timestamp])
  @@map("consent_logs")
}

model VoiceUsageEvent {
  id                  String   @id @default(cuid())
  voiceContributionId String
  voiceContribution   VoiceContribution @relation(fields: [voiceContributionId], references: [id], onDelete: Cascade)
  
  // Usage Context
  characterId         String
  userId              String?    // User who triggered TTS
  sessionId           String?    // For anonymous tracking
  
  // Metrics
  durationSeconds     Float
  textLength          Int        @default(0)
  
  // Idempotency  
  eventHash           String     @unique // SHA256(voiceId + characterId + timestamp + text)
  
  // Reward Attribution (Snapshot)
  awsTokensEarned     Float      @default(0)
  awsPriceAtEvent     Float?     // Market price snapshot
  
  createdAt           DateTime   @default(now())
  
  @@index([voiceContributionId])
  @@index([characterId])
  @@index([createdAt])
  @@map("voice_usage_events")
}

model VoiceRewardLedger {
  id                  String   @id @default(cuid())
  voiceContributionId String
  voiceContribution   VoiceContribution @relation(fields: [voiceContributionId], references: [id], onDelete: Cascade)
  
  // Period
  periodStart         DateTime
  periodEnd           DateTime
  
  // Aggregated Metrics
  totalMinutes        Float
  totalEvents         Int
  
  // Reward Calculation
  awsTokensEarned     Float
  cashEquivalentUsd   Float
  awsPriceUsed        Float    // Average price during period
  
  // Status
  status              String   @default("accruing") // accruing, pending_settlement, settled
  settlementId        String?
  
  createdAt           DateTime @default(now())
  
  @@unique([voiceContributionId, periodStart])
  @@index([status])
  @@map("voice_reward_ledger")
}

model VoiceSettlement {
  id                  String   @id @default(cuid())
  contributorId       String
  voiceContributionId String?
  voiceContribution   VoiceContribution? @relation(fields: [voiceContributionId], references: [id], onDelete: SetNull)
  
  // Period
  settlementPeriod    String   // "2026-Q1-P1" (Period 1 of Q1)
  periodStart         DateTime
  periodEnd           DateTime
  
  // Totals
  totalAwsTokens      Float
  totalCashUsd        Float
  
  // Payout Choice
  payoutType          String   @default("pending_choice") // aws_tokens, cash, split, pending_choice
  payoutSplitRatio    Float?   // If split, % in tokens (0.0-1.0)
  
  // Execution
  status              String   @default("pending") // pending, processing, completed, failed
  transactionHash     String?  // On-chain tx for tokens
  paypalTransactionId String?  // For cash
  failureReason       String?
  
  createdAt           DateTime @default(now())
  completedAt         DateTime?
  
  @@index([contributorId])
  @@index([status])
  @@index([periodStart])
  @@map("voice_settlements")
}

model VoiceCharacterLink {
  id                  String   @id @default(cuid())
  voiceContributionId String
  voiceContribution   VoiceContribution @relation(fields: [voiceContributionId], references: [id], onDelete: Cascade)
  characterId         String
  
  // Usage Stats (Cached for dashboard)
  totalMinutes        Float    @default(0)
  totalRevenue        Float    @default(0)
  usageCount          Int      @default(0)
  lastUsedAt          DateTime?
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@unique([voiceContributionId, characterId])
  @@index([characterId])
  @@map("voice_character_links")
}

model AdminAuditLog {
  id          String   @id @default(cuid())
  adminId     String
  action      String   // "approve_voice", "reject_voice", "flag_abuse", "create_bundle"
  targetType  String   // "voice_contribution", "settlement", "user"
  targetId    String
  metadata    String?  // JSON
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
  
  @@index([adminId])
  @@index([targetType, targetId])
  @@index([createdAt])
  @@map("admin_audit_log")
}
