generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model PersonaTemplate {
  id                   String                @id @default(cuid())
  seedId               String?               @unique
  name                 String
  handle               String?
  tagline              String?
  description          String?
  greeting             String?
  category             String
  avatarUrl            String
  voiceName            String
  styleHint            String?
  voiceSpeed           Float?
  voicePitch           Float?
  systemPrompt         String
  age                  Int?
  gender               String?
  heritage             String?
  accentProfile        String?
  ttsVoiceSpec         String?
  faceDescription      String?
  prompts              String?
  totalChats           String?
  referenceAudioUrl    String?
  referenceAudioBase64 String?
  openVoiceVoiceId     String?
  archetype            String
  tonePack             String?
  scenarioSkin         String?
  sourceCharacterName  String?
  sourceCharacterUrl   String?
  sourceType           String?
  sourceDescription    String?
  characterKeywords    String?
  mappingConfidence    Float?
  viewCount            Int                   @default(0)
  chatCount            Int                   @default(0)
  followerCount        Int                   @default(0)
  interactionCount     Int                   @default(0)
  saveCount            Int                   @default(0)
  commentCount         Int                   @default(0)
  retentionScore       Float                 @default(0.0)
  featured             Boolean               @default(false)
  trending             Boolean               @default(false)
  voiceReady           Boolean               @default(false)
  lastRankedAt         DateTime?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  comments             CharacterComment[]
  evolutions           CharacterEvolution[]
  memories             CharacterMemory[]
  saves                CharacterSave[]
  conversations        Conversation[]
  patterns             ConversationPattern[]
  views                PersonaView[]
  followers            UserFollow[]
  voiceParameters      VoiceParameters[]
  voicePerformances    VoicePerformance[]

  @@index([category])
  @@index([seedId])
  @@index([archetype])
  @@index([retentionScore])
  @@index([featured])
  @@index([trending])
}

model Conversation {
  id        String          @id @default(cuid())
  personaId String
  userId    String?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  user      User?           @relation(fields: [userId], references: [id], onDelete: Cascade)
  persona   PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)
  messages  Message[]

  @@index([personaId])
  @@index([userId])
}

model Message {
  id             String           @id @default(cuid())
  conversationId String
  role           String
  text           String
  audioUrl       String?
  createdAt      DateTime         @default(now())
  conversation   Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  feedback       MessageFeedback?
  pinned         PinnedMessage?
  voiceFeedback  VoiceFeedback?

  @@index([conversationId])
}

model MessageFeedback {
  id           String   @id @default(cuid())
  messageId    String   @unique
  userId       String?
  rating       Int?
  thumbsUp     Boolean?
  thumbsDown   Boolean?
  feedbackText String?
  createdAt    DateTime @default(now())
  user         User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  message      Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model CharacterMemory {
  id               String          @id @default(cuid())
  personaId        String
  userId           String          @default("")
  facts            String          @default("{}")
  preferences      String          @default("{}")
  patterns         String          @default("{}")
  emotionalState   String?
  interactionCount Int             @default(0)
  confidenceScore  Float           @default(0.5)
  lastInteraction  DateTime        @default(now())
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  persona          PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@unique([personaId, userId])
  @@index([personaId])
  @@index([userId])
}

model ConversationPattern {
  id           String          @id @default(cuid())
  personaId    String
  patternType  String
  patternKey   String
  patternValue String
  frequency    Int             @default(1)
  confidence   Float           @default(0.5)
  lastSeen     DateTime        @default(now())
  createdAt    DateTime        @default(now())
  persona      PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@unique([personaId, patternType, patternKey])
  @@index([personaId])
  @@index([confidence])
}

model CharacterEvolution {
  id                 String          @id @default(cuid())
  personaId          String
  version            Int
  improvements       String
  performanceMetrics String
  totalInteractions  Int             @default(0)
  averageRating      Float           @default(0.0)
  responseQuality    Float           @default(0.5)
  lastEvolved        DateTime        @default(now())
  createdAt          DateTime        @default(now())
  persona            PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@unique([personaId, version])
  @@index([personaId])
  @@index([version])
}

model UserQuota {
  id               String   @id @default(cuid())
  userId           String   @unique
  textRepliesToday Int      @default(0)
  ttsSecondsToday  Int      @default(0)
  callMinutesToday Int      @default(0)
  lastResetDate    DateTime @default(now())

  @@index([userId])
}

model Subscription {
  id                   String    @id @default(cuid())
  userId               String    @unique
  planId               String
  status               String
  currentPeriodEnd     DateTime?
  stripeCustomerId     String?
  stripeSubscriptionId String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@index([userId])
  @@index([status])
}

model User {
  id                 String              @id @default(cuid())
  email              String?             @unique
  username           String?             @unique
  displayName        String?
  avatarUrl          String?
  dateOfBirth        DateTime?
  ageVerified        Boolean             @default(false)
  ageVerifiedAt      DateTime?
  subscriptionTier   String              @default("free")
  stripeCustomerId   String?             @unique
  subscriptionId     String?             @unique
  subscriptionStatus String?
  creditsBalance     Int                 @default(100)
  referralCode       String?             @unique
  referredBy         String?
  referralCount      Int                 @default(0)
  referralClicks     Int                 @default(0)
  affiliateEarnings  Float               @default(0)
  unpaidEarnings     Float               @default(0)
  stripeConnectId    String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  characterComments  CharacterComment[]
  savedCharacters    CharacterSave[]
  conversations      Conversation[]
  creditPurchases    CreditPurchase[]
  creditTransactions CreditTransaction[]
  feedback           MessageFeedback[]
  payouts            Payout[]
  views              PersonaView[]
  pinnedMessages     PinnedMessage[]
  referralPurchases  ReferralPurchase[]
  following          UserFollow[]
  voiceFeedback      VoiceFeedback[]

  @@index([username])
  @@index([email])
  @@index([subscriptionTier])
  @@index([stripeCustomerId])
}

model UserFollow {
  id        String          @id @default(cuid())
  userId    String
  personaId String
  createdAt DateTime        @default(now())
  persona   PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, personaId])
  @@index([personaId])
  @@index([userId])
}

model PersonaView {
  id        String          @id @default(cuid())
  personaId String
  userId    String?
  viewedAt  DateTime        @default(now())
  user      User?           @relation(fields: [userId], references: [id], onDelete: Cascade)
  persona   PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@index([personaId])
  @@index([userId])
  @@index([viewedAt])
}

model PinnedMessage {
  id        String   @id @default(cuid())
  messageId String   @unique
  userId    String
  pinnedAt  DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VoicePerformance {
  id              String          @id @default(cuid())
  personaId       String
  voiceName       String
  userId          String?
  rating          Float           @default(3.0)
  engagementScore Float           @default(0.5)
  usageCount      Int             @default(0)
  lastUsed        DateTime        @default(now())
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  persona         PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@unique([personaId, voiceName, userId])
  @@index([personaId])
  @@index([rating])
  @@index([engagementScore])
}

model VoiceParameters {
  id               String          @id @default(cuid())
  personaId        String
  voiceName        String
  speed            Float           @default(1.0)
  pitch            Float           @default(1.0)
  styleHint        String?
  confidence       Float           @default(0.5)
  performanceScore Float           @default(0.0)
  usageCount       Int             @default(0)
  lastOptimized    DateTime        @default(now())
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  persona          PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@unique([personaId, voiceName])
  @@index([personaId])
  @@index([performanceScore])
}

model VoiceFeedback {
  id                String   @id @default(cuid())
  messageId         String   @unique
  personaId         String
  voiceName         String
  userId            String?
  voiceRating       Int?
  speedRating       Int?
  pitchRating       Int?
  naturalnessRating Int?
  feedbackText      String?
  createdAt         DateTime @default(now())
  user              User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  message           Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([personaId])
  @@index([voiceName])
  @@index([userId])
}

model CharacterSave {
  id        String          @id @default(cuid())
  personaId String
  userId    String
  createdAt DateTime        @default(now())
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  persona   PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@unique([userId, personaId])
  @@index([personaId])
  @@index([userId])
}

model CharacterComment {
  id        String          @id @default(cuid())
  personaId String
  userId    String
  text      String
  isPublic  Boolean         @default(true)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  persona   PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@index([personaId])
  @@index([userId])
  @@index([createdAt])
}

model TTSCache {
  id          String   @id @default(cuid())
  textHash    String   @unique
  text        String
  voiceId     String
  engine      String
  audioBase64 String
  format      String
  contentType String
  sampleRate  Int
  hitCount    Int      @default(0)
  lastUsed    DateTime @default(now())
  createdAt   DateTime @default(now())

  @@index([engine])
  @@index([hitCount])
  @@index([lastUsed])
}

model CreditPack {
  id            String           @id @default(cuid())
  name          String
  credits       Int
  priceUsd      Float
  stripePriceId String?          @unique
  isActive      Boolean          @default(true)
  displayOrder  Int              @default(0)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  purchases     CreditPurchase[]

  @@index([isActive])
  @@index([displayOrder])
}

model CreditPurchase {
  id              String      @id @default(cuid())
  userId          String
  creditPackId    String?
  creditsAdded    Int
  amountPaid      Float
  stripeSessionId String?     @unique
  status          String      @default("pending")
  createdAt       DateTime    @default(now())
  creditPack      CreditPack? @relation(fields: [creditPackId], references: [id])
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model CreditTransaction {
  id           String   @id @default(cuid())
  userId       String
  amount       Int
  actionType   String
  description  String?
  balanceAfter Int
  metadata     String?  @default("{}")
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([actionType])
  @@index([createdAt])
}

model ReferralPurchase {
  id             String    @id @default(cuid())
  referrerId     String
  purchaseAmount Float
  commissionRate Float     @default(0.30)
  commission     Float
  status         String    @default("pending")
  holdUntil      DateTime?
  createdAt      DateTime  @default(now())
  paidAt         DateTime?
  referrer       User      @relation(fields: [referrerId], references: [id], onDelete: Cascade)

  @@index([referrerId])
  @@index([status])
  @@index([createdAt])
}

model Payout {
  id        String    @id @default(cuid())
  userId    String
  amount    Float
  status    String    @default("processing")
  period    String
  createdAt DateTime  @default(now())
  paidAt    DateTime?
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}
