generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =============================================
// VOICE-FIRST ARCHITECTURE (Rule Zero)
// Voices are first-class objects. Characters are derived.
// =============================================

// =============================================
// VOICE SEED (Elite Voice Pool - 29 Base Voices)
// These are the immutable source assets. Characters select from this pool.
// =============================================
model VoiceSeed {
  id           String   @id @default(cuid())
  name         String   @unique  // "Movetrailer", "WiseSage", etc.
  filePath     String              // "/voices/seeds/Movetrailer.mp3"
  gender       String              // "male", "female", "neutral"
  age          String              // "young", "adult", "middle_aged", "elderly", "ageless"
  tone         String              // "deep", "bright", "raspy", "soft", "warm", etc.
  energy       String              // "calm", "epic", "chaotic", "intimate", "zen", etc.
  accent       String              // "american", "british", "french", "australian", etc.
  category     String              // "Authority", "Mentor", "Energetic", "Texture", "Global"
  tags         String              // JSON array: ["narrator", "villain", "comedy"]
  suitableFor  String              // JSON array: ["villains", "mentors", "heroes"]
  description  String?             // Human-readable description
  referenceText String?            // Transcript of the reference audio (Prevents double-talk)
  
  // Relations
  characters   PersonaTemplate[]   @relation("VoiceSeedCharacters")
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@map("voice_seeds")
  @@index([gender])
  @@index([category])
  @@index([accent])
}

model VoiceIdentity {
  id              String   @id @default(cuid())
  voiceId         String   @unique  // Immutable: e.g., "voice_oxford_female_01"
  
  // === Layer 1: VOICE IDENTITY (Human-Readable, Immutable) ===
  gender          String   // male | female
  ageBand         String   // young | adult | middle-aged | elderly
  originRegion    String   // e.g., west_africa, england_oxford
  accent          String   // african_english | british-rp | etc.
  ethnicityAnchor String?  // black | white | asian | etc.
  authorityLevel  String?  // soft | neutral | commanding | dominant
  
  // === Layer 2: NUMERIC VOICE LOCK (TTS-Enforced) ===
  // Pitch (Hz or relative scale)
  pitchMin        Int      @default(100)
  pitchMax        Int      @default(200)
  
  // Speed (Words per minute or scalar * 100)
  speakingRateMin Int      @default(90)
  speakingRateMax Int      @default(110)
  
  // Dynamics (0-100)
  energyBaseline  Int      @default(50)
  aggressionBaseline Int   @default(0)
  
  // Timbre & Texture (0-100)
  articulationPrecision Int @default(50)
  rhythmVariability     Int @default(50)
  warmth               Int  @default(50)
  roughness            Int  @default(10)
  
  // Internal Locks
  accentId             Int  @default(0)
  genderLock           Int  @default(0) // 0=female, 1=male
  ageLock              Int  @default(1) // 0=young, 1=adult, 2=middle, 3=elderly
  
  // === Layer 3: NEGATIVE CONSTRAINTS (Crucial) ===
  voiceProhibitions    String  @default("{}") // JSON string: { forbidden_accents: [], forbidden_genders: [] }
  
  // Legacy / Compatibility Fields (To be phased out or mapped)
  language        String   @default("en") 
  socialRegister  String?
  timbre          String?
  energyLevel     String?
  aggressionLevel String?
  speakingRate    Float    @default(1.0)
  pitchBaselineHz Int      @default(150)
  pitchVariance   String?
  cadenceStyle    String?
  
  // v2 Fields
  expressivenessLevel  String   @default("controlled")
  emotionalLeakage     String   @default("none")
  articulationStyle    String   @default("precise")
  confidenceStability  String   @default("steady")
  breathiness          String   @default("none")
  quirkTag             String?

  villainCapable  Boolean  @default(false)
  
  // Reference Audio
  referenceAudioPath String
  referenceText      String?
  
  // Metadata
  displayName     String?
  description     String?
  voiceDescription String? // Natural language prompt
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relation to characters
  characters      PersonaTemplate[]
  
  @@map("voice_identities")
  @@index([gender])
  @@index([accent])
}

model PersonaTemplate {
  id                   String                    @id @default(cuid())
  seedId               String?                   @unique
  name                 String
  handle               String?
  tagline              String?
  description          String?
  greeting             String?
  category             String
  avatarUrl            String
  voiceName            String
  styleHint            String?
  voiceSpeed           Float?
  voicePitch           Float?
  systemPrompt         String
  age                  Int?
  gender               String?
  heritage             String?
  accentProfile        String?
  ttsVoiceSpec         String?
  faceDescription      String?
  prompts              String?
  totalChats           String?
  referenceAudioUrl    String?
  referenceAudioBase64 String?
  openVoiceVoiceId     String?
  archetype            String
  tonePack             String?
  scenarioSkin         String?
  sourceCharacterName  String?
  sourceCharacterUrl   String?
  sourceType           String?
  sourceDescription    String?
  characterKeywords    String?
  mappingConfidence    Float?
  viewCount            Int                       @default(0)
  chatCount            Int                       @default(0)
  followerCount        Int                       @default(0)
  interactionCount     Int                       @default(0)
  saveCount            Int                       @default(0)
  commentCount         Int                       @default(0)
  retentionScore       Float                     @default(0.0)
  featured             Boolean                   @default(false)
  trending             Boolean                   @default(false)
  voiceReady           Boolean                   @default(false)
  lastRankedAt         DateTime?
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @updatedAt
  creationError        String?
  creationMessage      String?
  creationProgress     Int?                      @default(0)
  creationStatus       String?
  behaviorAgreeable    Float?                    @default(50)
  behaviorEmpathy      Float?                    @default(50)
  knowledgeBaseUrl     String?
  styleFormality       Float?                    @default(50)
  styleVerbosity       Float?                    @default(50)
  trainingConstraints  String?
  trainingStatus       String?                   @default("untrained")
  behaviorChaos        Float?                    @default(50)
  behaviorPessimism    Float?                    @default(50)
  personalityTags      String?
  
  // VOICE-FIRST: Link to canonical voice identity
  voiceIdentityId      String?
  voiceIdentity        VoiceIdentity?            @relation(fields: [voiceIdentityId], references: [id])
  
  // VOICE POOL: Link to Elite Voice Seed (29 base voices)
  voiceSeedId          String?
  voiceSeed            VoiceSeed?                @relation("VoiceSeedCharacters", fields: [voiceSeedId], references: [id])
  
  comments             CharacterComment[]
  evolutions           CharacterEvolution[]
  memories             CharacterMemory[]
  saves                CharacterSave[]
  conversations        Conversation[]
  patterns             ConversationPattern[]
  views                PersonaView[]
  engagements          UserCharacterEngagement[]
  followers            UserFollow[]
  voiceParameters      VoiceParameters[]
  voicePerformances    VoicePerformance[]

  @@index([category])
  @@index([seedId])
  @@index([archetype])
  @@index([retentionScore])
  @@index([featured])
  @@index([trending])
  @@index([voiceIdentityId])
  @@index([voiceSeedId])
}

model Conversation {
  id        String          @id @default(cuid())
  personaId String
  userId    String?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  user      User?           @relation(fields: [userId], references: [id], onDelete: Cascade)
  persona   PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)
  messages  Message[]

  @@index([personaId])
  @@index([userId])
}

model Message {
  id             String           @id @default(cuid())
  conversationId String
  role           String
  text           String
  audioUrl       String?
  createdAt      DateTime         @default(now())
  conversation   Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  feedback       MessageFeedback?
  pinned         PinnedMessage?
  voiceFeedback  VoiceFeedback?

  @@index([conversationId])
}

model MessageFeedback {
  id           String   @id @default(cuid())
  messageId    String   @unique
  userId       String?
  rating       Int?
  thumbsUp     Boolean?
  thumbsDown   Boolean?
  feedbackText String?
  createdAt    DateTime @default(now())
  user         User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  message      Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model CharacterMemory {
  id               String          @id @default(cuid())
  personaId        String
  userId           String          @default("")
  facts            String          @default("{}")
  preferences      String          @default("{}")
  patterns         String          @default("{}")
  emotionalState   String?
  interactionCount Int             @default(0)
  confidenceScore  Float           @default(0.5)
  lastInteraction  DateTime        @default(now())
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  persona          PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@unique([personaId, userId])
  @@index([personaId])
  @@index([userId])
}

model ConversationPattern {
  id           String          @id @default(cuid())
  personaId    String
  patternType  String
  patternKey   String
  patternValue String
  frequency    Int             @default(1)
  confidence   Float           @default(0.5)
  lastSeen     DateTime        @default(now())
  createdAt    DateTime        @default(now())
  persona      PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@unique([personaId, patternType, patternKey])
  @@index([personaId])
  @@index([confidence])
}

model CharacterEvolution {
  id                 String          @id @default(cuid())
  personaId          String
  version            Int
  improvements       String
  performanceMetrics String
  totalInteractions  Int             @default(0)
  averageRating      Float           @default(0.0)
  responseQuality    Float           @default(0.5)
  lastEvolved        DateTime        @default(now())
  createdAt          DateTime        @default(now())
  persona            PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@unique([personaId, version])
  @@index([personaId])
  @@index([version])
}

model UserQuota {
  id               String   @id @default(cuid())
  userId           String   @unique
  textRepliesToday Int      @default(0)
  ttsSecondsToday  Int      @default(0)
  callMinutesToday Int      @default(0)
  lastResetDate    DateTime @default(now())

  @@index([userId])
}

model Subscription {
  id                   String    @id @default(cuid())
  userId               String    @unique
  planId               String
  status               String
  currentPeriodEnd     DateTime?
  stripeCustomerId     String?
  stripeSubscriptionId String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@index([userId])
  @@index([status])
}

model User {
  id                 String                    @id @default(cuid())
  email              String?                   @unique
  username           String?                   @unique
  displayName        String?
  bio                String?
  avatarUrl          String?
  dateOfBirth        DateTime?
  ageVerified        Boolean                   @default(false)
  ageVerifiedAt      DateTime?
  subscriptionTier   String                    @default("free")
  stripeCustomerId   String?                   @unique
  subscriptionId     String?                   @unique
  subscriptionStatus String?
  creditsBalance     Int                       @default(100)
  referralCode       String?                   @unique
  referredBy         String?
  referralCount      Int                       @default(0)
  referralClicks     Int                       @default(0)
  affiliateEarnings  Float                     @default(0)
  unpaidEarnings     Float                     @default(0)
  stripeConnectId    String?
  createdAt          DateTime                  @default(now())
  updatedAt          DateTime                  @updatedAt
  characterComments  CharacterComment[]
  savedCharacters    CharacterSave[]
  conversations      Conversation[]
  creditPurchases    CreditPurchase[]
  creditTransactions CreditTransaction[]
  feedback           MessageFeedback[]
  payouts            Payout[]
  views              PersonaView[]
  pinnedMessages     PinnedMessage[]
  referralPurchases  ReferralPurchase[]
  engagements        UserCharacterEngagement[]
  following          UserFollow[]
  loginStreak        UserLoginStreak?
  rewardProgress     UserRewardProgress[]
  voiceFeedback      VoiceFeedback[]

  @@index([username])
  @@index([email])
  @@index([subscriptionTier])
  @@index([stripeCustomerId])
}

model UserFollow {
  id        String          @id @default(cuid())
  userId    String
  personaId String
  createdAt DateTime        @default(now())
  persona   PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, personaId])
  @@index([personaId])
  @@index([userId])
}

model PersonaView {
  id        String          @id @default(cuid())
  personaId String
  userId    String?
  viewedAt  DateTime        @default(now())
  user      User?           @relation(fields: [userId], references: [id], onDelete: Cascade)
  persona   PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@index([personaId])
  @@index([userId])
  @@index([viewedAt])
}

model PinnedMessage {
  id        String   @id @default(cuid())
  messageId String   @unique
  userId    String
  pinnedAt  DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VoicePerformance {
  id              String          @id @default(cuid())
  personaId       String
  voiceName       String
  userId          String?
  rating          Float           @default(3.0)
  engagementScore Float           @default(0.5)
  usageCount      Int             @default(0)
  lastUsed        DateTime        @default(now())
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  persona         PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@unique([personaId, voiceName, userId])
  @@index([personaId])
  @@index([rating])
  @@index([engagementScore])
}

model VoiceParameters {
  id               String          @id @default(cuid())
  personaId        String
  voiceName        String
  speed            Float           @default(1.0)
  pitch            Float           @default(1.0)
  styleHint        String?
  confidence       Float           @default(0.5)
  performanceScore Float           @default(0.0)
  usageCount       Int             @default(0)
  lastOptimized    DateTime        @default(now())
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  persona          PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@unique([personaId, voiceName])
  @@index([personaId])
  @@index([performanceScore])
}

model VoiceFeedback {
  id                String   @id @default(cuid())
  messageId         String   @unique
  personaId         String
  voiceName         String
  userId            String?
  voiceRating       Int?
  speedRating       Int?
  pitchRating       Int?
  naturalnessRating Int?
  feedbackText      String?
  createdAt         DateTime @default(now())
  user              User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  message           Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([personaId])
  @@index([voiceName])
  @@index([userId])
}

model CharacterSave {
  id        String          @id @default(cuid())
  personaId String
  userId    String
  createdAt DateTime        @default(now())
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  persona   PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@unique([userId, personaId])
  @@index([personaId])
  @@index([userId])
}

model CharacterComment {
  id        String          @id @default(cuid())
  personaId String
  userId    String
  text      String
  isPublic  Boolean         @default(true)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  persona   PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)

  @@index([personaId])
  @@index([userId])
  @@index([createdAt])
}

model TTSCache {
  id          String   @id @default(cuid())
  textHash    String   @unique
  text        String
  voiceId     String
  engine      String
  audioBase64 String
  format      String
  contentType String
  sampleRate  Int
  hitCount    Int      @default(0)
  lastUsed    DateTime @default(now())
  createdAt   DateTime @default(now())

  @@index([engine])
  @@index([hitCount])
  @@index([lastUsed])
}

model CreditPack {
  id            String           @id @default(cuid())
  name          String
  credits       Int
  priceUsd      Float
  stripePriceId String?          @unique
  isActive      Boolean          @default(true)
  displayOrder  Int              @default(0)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  purchases     CreditPurchase[]

  @@index([isActive])
  @@index([displayOrder])
}

model CreditPurchase {
  id              String      @id @default(cuid())
  userId          String
  creditPackId    String?
  creditsAdded    Int
  amountPaid      Float
  stripeSessionId String?     @unique
  status          String      @default("pending")
  createdAt       DateTime    @default(now())
  creditPack      CreditPack? @relation(fields: [creditPackId], references: [id])
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model CreditTransaction {
  id           String   @id @default(cuid())
  userId       String
  amount       Int
  actionType   String
  description  String?
  balanceAfter Int
  metadata     String?  @default("{}")
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([actionType])
  @@index([createdAt])
}

model ReferralPurchase {
  id             String    @id @default(cuid())
  referrerId     String
  purchaseAmount Float
  commissionRate Float     @default(0.30)
  commission     Float
  status         String    @default("pending")
  holdUntil      DateTime?
  createdAt      DateTime  @default(now())
  paidAt         DateTime?
  referrer       User      @relation(fields: [referrerId], references: [id], onDelete: Cascade)

  @@index([referrerId])
  @@index([status])
  @@index([createdAt])
}

model Payout {
  id        String    @id @default(cuid())
  userId    String
  amount    Float
  status    String    @default("processing")
  period    String
  createdAt DateTime  @default(now())
  paidAt    DateTime?
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model UserRewardProgress {
  id        String    @id @default(cuid())
  userId    String
  rewardId  String
  progress  Int       @default(0)
  claimed   Boolean   @default(false)
  claimedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, rewardId])
  @@index([userId])
}

model UserCharacterEngagement {
  id            String          @id @default(cuid())
  userId        String
  personaId     String
  messagesSent  Int             @default(0)
  lastChatAt    DateTime?
  totalChatTime Int             @default(0)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  persona       PersonaTemplate @relation(fields: [personaId], references: [id], onDelete: Cascade)
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, personaId])
  @@index([userId])
  @@index([personaId])
}

model UserLoginStreak {
  id            String   @id @default(cuid())
  userId        String   @unique
  currentStreak Int      @default(0)
  longestStreak Int      @default(0)
  lastLoginDate DateTime @default(now())
  createdAt     DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model NewsletterSubscriber {
  id           String   @id @default(cuid())
  email        String   @unique
  subscribedAt DateTime @default(now())
  source       String   @default("landing_page")
  isActive     Boolean  @default(true)

  @@index([email])
}

// =============================================
// BLOG ENGAGEMENT
// =============================================

model BlogLike {
  id        String   @id @default(cuid())
  slug      String   // Blog post slug
  userId    String?  // Optional user ID
  sessionId String?  // For anonymous likes
  createdAt DateTime @default(now())

  @@unique([slug, userId])
  @@unique([slug, sessionId])
  @@index([slug])
}

model BlogComment {
  id        String   @id @default(cuid())
  slug      String   // Blog post slug
  userId    String?
  name      String   // Display name (for anonymous or logged in)
  email     String?  // Optional email
  content   String
  approved  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([createdAt])
}
